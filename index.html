<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQL Visualiser - Robust CSV</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>

    <style>
        /* --- THEME VARIABLES --- */
        :root {
            /* Light Theme (Default) */
            --bg-body: #f8fafc;
            --bg-panel: #ffffff;
            --bg-header: #f1f5f9;
            
            --text-main: #0f172a;
            --text-muted: #64748b;
            --border: #e2e8f0;
            
            --primary: #3b82f6;
            --primary-bg: #eff6ff;
            --success: #10b981;
            --danger: #ef4444;
            
            /* Visualization Colors */
            --anim-scan: #fef08a; 
            --anim-cell: #f472b6; 
            --anim-match: #86efac; 
            --text-highlight: #000000;
            
            /* Scrollbars */
            --scroll-track: #f1f5f9;
            --scroll-thumb: #cbd5e1;
            
            /* Syntax Highlighting */
            --code-bg: #ffffff;
            --code-text: #0f172a;
            --code-kw: #d73a49; 
            --code-str: #032f62; 
            --code-fn: #6f42c1; 
            --code-com: #6a737d; 
        }

        body.dark-mode {
            /* Dark Theme */
            --bg-body: #0f172a;
            --bg-panel: #1e293b;
            --bg-header: #334155;
            
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --border: #334155;
            --primary-bg: #1e3a8a;
            
            /* Viz Colors Dark */
            --anim-scan: #422006;
            --anim-cell: #831843;
            --anim-match: #064e3b;
            --text-highlight: #ffffff;
            
            /* Scrollbars Dark */
            --scroll-track: #0f172a;
            --scroll-thumb: #475569;

            /* Syntax Highlighting Dark */
            --code-bg: #1e293b;
            --code-text: #f1f5f9;
            --code-kw: #ff7b72; 
            --code-str: #a5d6ff;
            --code-fn: #d2a8ff;
            --code-com: #8b949e;
        }

        * { box-sizing: border-box; }
        
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--scroll-track); }
        ::-webkit-scrollbar-thumb { background: var(--scroll-thumb); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }
        * { scrollbar-width: thin; scrollbar-color: var(--scroll-thumb) var(--scroll-track); }

        body { 
            font-family: 'Inter', system-ui, sans-serif; 
            margin: 0; 
            background: var(--bg-body); 
            color: var(--text-main); 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
        }

        /* HEADER */
        header { background: var(--bg-panel); border-bottom: 1px solid var(--border); padding: 0 20px; height: 50px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .brand { font-weight: 800; color: var(--primary); font-size: 1.1rem; letter-spacing: -0.5px; }
        .controls { display: flex; gap: 10px; align-items: center; }
        .btn { padding: 6px 12px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg-panel); color: var(--text-main); cursor: pointer; font-size: 0.8rem; font-weight: 500; }
        .btn:hover { background: var(--bg-header); }
        .btn-primary { background: var(--primary); color: white; border: none; }
        .btn-primary:hover { filter: brightness(1.1); }

        /* LAYOUT CONTAINERS */
        main { display: flex; flex: 1; overflow: hidden; }
        
        /* LEFT: SCHEMA */
        #schema-panel { width: 300px; background: var(--bg-panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; flex-shrink: 0; }
        .sidebar-header { padding: 10px; border-bottom: 1px solid var(--border); background: var(--bg-header); display: flex; flex-direction: column; gap: 8px; }
        #tables-container { flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 15px; }

        .input-group { display: flex; gap: 5px; }
        .input-text { flex: 1; padding: 6px; border: 1px solid var(--border); border-radius: 4px; background: var(--bg-body); color: var(--text-main); outline: none; font-size: 0.85rem; }
        .input-text:focus { border-color: var(--primary); }

        /* TABLE CARDS */
        .table-card { border: 1px solid var(--border); border-radius: 6px; overflow: hidden; background: var(--bg-body); box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .card-title { padding: 8px 10px; background: var(--bg-panel); border-bottom: 1px solid var(--border); font-weight: 600; font-size: 0.85rem; display: flex; justify-content: space-between; align-items: center; }
        .icon-btn { cursor: pointer; opacity: 0.6; transition: 0.2s; padding: 2px 6px; font-size: 11px; border-radius: 4px; border: 1px solid transparent; }
        .icon-btn:hover { opacity: 1; background: rgba(239, 68, 68, 0.1); color: var(--danger); border-color: var(--danger); }

        .db-grid { width: 100%; border-collapse: collapse; font-size: 0.8rem; table-layout: fixed; }
        .db-row-header { display: grid; border-bottom: 1px solid var(--border); background: var(--bg-header); font-weight: bold; }
        .db-row { display: grid; border-bottom: 1px solid var(--border); background: var(--bg-panel); }
        .db-cell { padding: 0; border-right: 1px solid var(--border); position: relative; }
        
        .cell-input {
            width: 100%; padding: 6px 8px; border: none; background: transparent; color: inherit; font-family: monospace; 
            text-overflow: ellipsis; white-space: nowrap; overflow: hidden;
        }
        .cell-input:focus { background: var(--bg-body); outline: none; box-shadow: inset 0 0 0 2px var(--primary); }
        .db-row-header .cell-input { font-weight: bold; color: var(--text-main); }

        .card-actions { display: flex; border-top: 1px solid var(--border); background: var(--bg-panel); }
        .card-actions button {
            flex: 1; border: none; background: transparent; padding: 6px; font-size: 0.75rem; color: var(--primary); cursor: pointer; border-right: 1px solid var(--border);
        }
        .card-actions button:last-child { border-right: none; }
        .card-actions button:hover { background: var(--bg-header); }

        /* RIGHT: WORKBENCH */
        #workbench { flex: 1; display: flex; flex-direction: column; padding: 15px; gap: 15px; overflow: hidden; }

        /* TOP PANE */
        #top-pane { display: flex; gap: 15px; height: 260px; flex-shrink: 0; }
        
        /* PIPELINE */
        #pipeline-col { 
            width: 180px; display: flex; flex-direction: column; gap: 5px; overflow-y: auto; 
            background: var(--bg-panel); padding: 10px; border: 1px solid var(--border); border-radius: 8px; 
        }
        .pipe-step { 
            padding: 6px 10px; background: var(--bg-body); border: 1px solid var(--border); border-radius: 4px; 
            font-size: 0.75rem; font-weight: bold; color: var(--text-muted); display: flex; justify-content: space-between;
            transition: all 0.3s;
        }
        .pipe-step.active { border-left: 3px solid var(--primary); background: var(--bg-panel); color: var(--text-main); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .pipe-step.done { border-left: 3px solid var(--success); opacity: 0.6; }

        /* SQL EDITOR */
        #editor-col { flex: 1; display: flex; flex-direction: column; border: 1px solid var(--border); border-radius: 8px; overflow: hidden; background: var(--bg-panel); }
        .tabs { display: flex; background: var(--bg-header); border-bottom: 1px solid var(--border); }
        .tab { padding: 8px 15px; font-size: 0.8rem; cursor: pointer; color: var(--text-muted); border-right: 1px solid var(--border); }
        .tab.active { background: var(--bg-panel); color: var(--primary); font-weight: bold; border-bottom: 2px solid var(--primary); }
        
        .editor-wrapper { position: relative; flex: 1; overflow: hidden; background: var(--code-bg); cursor: text; }
        
        #code-input {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            margin: 0; padding: 15px; border: none; outline: none; resize: none;
            background: transparent; color: transparent; caret-color: var(--text-main);
            font-family: 'Consolas', 'Monaco', monospace; font-size: 14px; line-height: 1.5;
            z-index: 2; overflow: auto; white-space: pre;
        }
        
        #code-highlight {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            margin: 0; padding: 15px; border: none;
            font-family: 'Consolas', 'Monaco', monospace; font-size: 14px; line-height: 1.5;
            background: var(--code-bg); color: var(--code-text);
            z-index: 1; overflow: hidden; pointer-events: none; white-space: pre;
        }

        /* Syntax Colors */
        .kwd { color: var(--code-kw); font-weight: bold; }
        .str { color: var(--code-str); }
        .com { color: var(--code-com); font-style: italic; }
        .fn { color: var(--code-fn); }

        .editor-footer { padding: 8px; background: var(--bg-header); text-align: right; border-top: 1px solid var(--border); z-index: 3; position: relative; }
        #pane-msg { flex: 1; padding: 15px; display: none; color: var(--danger); font-family: monospace; overflow: auto; }

        /* MIDDLE: VIZ STAGE */
        #viz-stage { 
            flex: 2; background: var(--bg-panel); border: 1px solid var(--border); border-radius: 8px; 
            display: flex; flex-direction: column; overflow: hidden; position: relative; 
        }
        .viz-header { padding: 8px 15px; border-bottom: 1px solid var(--border); font-size: 0.8rem; font-weight: bold; color: var(--text-muted); display: flex; justify-content: space-between; }
        
        #anim-canvas { 
            flex: 1; padding: 20px; overflow: auto; display: flex; flex-direction: column; gap: 30px;
        }

        /* VIZ TABLES */
        .viz-row-container { display: flex; gap: 20px; align-items: flex-start; width: 100%; flex-wrap: wrap; }
        .v-table-wrapper { display: flex; flex-direction: column; gap: 5px; flex: 1; min-width: 200px; }
        .v-label { font-size: 0.75rem; font-weight: bold; color: var(--primary); text-transform: uppercase; letter-spacing: 0.5px; }

        .v-table { 
            border: 1px solid var(--border); border-radius: 6px; background: var(--bg-body); 
            display: flex; flex-direction: column; box-shadow: 0 2px 4px rgba(0,0,0,0.05); overflow: hidden;
        }
        .v-row { display: grid; padding: 0; border-bottom: 1px solid var(--border); font-family: monospace; font-size: 0.8rem; transition: background 0.1s; gap:1px; }
        
        .v-cell { 
            padding: 6px 8px; border-right: 1px solid var(--border); overflow: hidden; 
            text-overflow: ellipsis; white-space: nowrap; transition: background 0.2s; 
            background: var(--bg-panel); color: var(--text-main); 
        }
        
        .v-header-row { background: var(--bg-header); font-weight: bold; }
        .v-header-row .v-cell { background: var(--bg-header); }

        .arrow-icon { align-self: center; font-size: 1.5rem; color: var(--text-muted); padding-top: 20px; }

        /* Animation States with High Contrast Text */
        .row-scanning .v-cell { 
            background-color: var(--anim-scan) !important; 
            color: var(--text-highlight) !important; 
        }
        
        .cell-reading { 
            background-color: var(--anim-cell) !important; 
            color: #fff !important; 
            font-weight: bold; 
            transform: scale(1.1); 
            box-shadow: 0 0 5px rgba(0,0,0,0.2); 
            z-index: 10; 
        }
        
        .row-matched .v-cell { 
            background-color: var(--anim-match) !important; 
            color: var(--text-highlight) !important; 
            transition: background 0.5s; 
        }

        /* BOTTOM: RESULTS */
        #result-pane { flex: 1; min-height: 180px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg-panel); display: flex; flex-direction: column; overflow: hidden; }
        .res-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .res-table th { position: sticky; top: 0; background: var(--bg-header); padding: 8px; text-align: left; border-bottom: 1px solid var(--border); color: var(--text-muted); }
        .res-table td { padding: 6px 8px; border-bottom: 1px solid var(--border); }
        .new-res-row { animation: flashGreen 1s; }
        @keyframes flashGreen { 0% { background: var(--anim-match); } 100% { background: transparent; } }

        /* --- RESPONSIVE MOBILE --- */
        @media (max-width: 900px) {
            body { height: auto; overflow-y: auto; }
            header { height: auto; flex-wrap: wrap; padding: 10px 15px; gap: 10px; }
            .controls { width: 100%; justify-content: space-between; }
            main { flex-direction: column; overflow: visible; height: auto; }
            #schema-panel { width: 100%; height: auto; max-height: 400px; border-right: none; border-bottom: 1px solid var(--border); }
            #workbench { padding: 10px; gap: 20px; overflow: visible; height: auto; }
            #top-pane { flex-direction: column; height: auto; }
            #pipeline-col { width: 100%; flex-direction: row; flex-wrap: wrap; height: auto; max-height: 120px; }
            .pipe-step { flex: 1 1 40%; } 
            #editor-col { height: 350px; }
            #viz-stage { height: 400px; flex: none; }
            #result-pane { height: 300px; flex: none; }
        }
    </style>
</head>
<body>

<header>
    <div class="brand">SQL Visualiser</div>
    <div class="controls">
        <label style="font-size:0.8rem">Speed:</label>
        <input type="range" min="1" max="10" value="7" oninput="setSpeed(this.value)">
        <button class="btn" onclick="toggleTheme()">Theme</button>
        <button class="btn btn-danger" onclick="location.reload()">Reset</button>
    </div>
</header>

<main>
    <section id="schema-panel">
        <div class="sidebar-header">
            <div class="input-group">
                <input type="text" id="new-table-name" class="input-text" placeholder="New Table Name">
                <button class="btn btn-primary" onclick="addTable()">+ Table</button>
            </div>
            <div class="input-group">
                <label for="csv-upload" class="btn" style="flex:1; text-align:center; font-size:0.8rem; cursor:pointer;">ðŸ“‚ Upload CSV</label>
                <input type="file" id="csv-upload" accept=".csv" style="display:none" onchange="handleCSV(this)">
            </div>
        </div>
        <div id="tables-container"></div>
    </section>

    <section id="workbench">
        <div id="top-pane">
            <div id="pipeline-col">
                <div style="font-weight:bold; font-size:0.8rem; margin-bottom:5px;">Execution Plan</div>
                <div id="pipeline-list"><div class="pipe-step">Waiting...</div></div>
            </div>

            <div id="editor-col">
                <div class="tabs">
                    <div class="tab active" onclick="showTab('editor')">SQL Editor</div>
                    <div class="tab" id="tab-msg" onclick="showTab('msg')">Messages</div>
                </div>
                
                <div id="pane-editor" style="flex:1; display:flex; flex-direction:column; position:relative;">
                    <div class="editor-wrapper" onclick="document.getElementById('code-input').focus()">
                        <div id="code-highlight"></div>
                        <textarea id="code-input" spellcheck="false" oninput="updateEditor(this)" onscroll="syncScroll(this)">SELECT 
    o.id as OrderID, 
    c.name as Customer, 
    p.name as Product,
    o.quantity
FROM Orders o
JOIN Customers c ON o.customer_id = c.id
JOIN Products p ON o.product_id = p.id
WHERE o.quantity > 0</textarea>
                    </div>
                    <div class="editor-footer">
                        <button class="btn btn-primary" onclick="startExecution()">â–¶ Run & Visualize</button>
                    </div>
                </div>
                <div id="pane-msg"></div>
            </div>
        </div>

        <div id="viz-stage">
            <div class="viz-header">
                <span>Process Visualization</span>
                <span id="status-text" style="color:var(--primary)">Idle</span>
            </div>
            <div id="anim-canvas"></div>
        </div>

        <div id="result-pane">
            <div style="padding:8px; border-bottom:1px solid var(--border); font-weight:bold; font-size:0.8rem; background:var(--bg-header);">Final Output</div>
            <div style="flex:1; overflow:auto;">
                <table class="res-table" id="res-table"><thead></thead><tbody></tbody></table>
            </div>
        </div>
    </section>
</main>

<script>
    let db = null;
    let SQL = null;
    let delay = 300;
    let isDark = false;

    // --- DATA ---
    const defaultData = {
        Products: [
            { id: 1, name: "Laptop", price: 1200 },
            { id: 2, name: "Mouse", price: 25 },
            { id: 3, name: "Monitor", price: 300 }
        ],
        Customers: [
            { id: 1, name: "Alice" },
            { id: 2, name: "Bob" }
        ],
        Orders: [
            { id: 101, customer_id: 1, product_id: 1, quantity: 1 },
            { id: 102, customer_id: 2, product_id: 2, quantity: 2 },
            { id: 103, customer_id: 1, product_id: 3, quantity: 1 }
        ]
    };
    let appData = JSON.parse(JSON.stringify(defaultData));

    // --- INIT ---
    async function init() {
        // Theme Detection
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            toggleTheme(); 
        }

        const config = { locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}` };
        SQL = await initSqlJs(config);
        
        // Init Editor Highlighting
        updateEditor(document.getElementById('code-input'));
        
        renderSchema();
    }

    // --- CSV PARSING (Robust) ---
    function handleCSV(input) {
        const file = input.files[0];
        if(!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const text = e.target.result;
            // Robust Regex for CSV splitting (handles quoted strings including commas)
            const regex = /,(?=(?:(?:[^"]*"){2})*[^"]*$)/; 
            
            const lines = text.split(/\r?\n/).filter(line => line.trim() !== '');
            if(lines.length < 2) return alert("CSV must have header and at least one row");
            
            // Clean quotes from header
            const headers = lines[0].split(regex).map(h => h.trim().replace(/^"|"$/g, ''));
            const tableName = file.name.replace('.csv', '').replace(/[^a-zA-Z0-9]/g, '_');
            
            const rows = [];
            for(let i=1; i<lines.length; i++) {
                const vals = lines[i].split(regex).map(v => v.trim().replace(/^"|"$/g, ''));
                if(vals.length === headers.length) {
                    let row = {};
                    headers.forEach((h, idx) => row[h] = vals[idx]);
                    rows.push(row);
                }
            }
            
            appData[tableName] = rows;
            renderSchema();
            input.value = ''; 
        };
        reader.readAsText(file);
    }

    // --- EDITOR LOGIC ---
    function updateEditor(el) {
        const text = el.value;
        let html = text
            .replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;")
            .replace(/(--.*)/g, '<span class="com">$1</span>')
            .replace(/('.*?')/g, '<span class="str">$1</span>')
            .replace(/\b(SELECT|FROM|WHERE|JOIN|ON|GROUP BY|ORDER BY|LIMIT|AS|WITH|INSERT|UPDATE|DELETE|CREATE|AND|OR|NOT|NULL)\b/gi, '<span class="kwd">$1</span>')
            .replace(/\b(COUNT|SUM|AVG|MAX|MIN)\b/gi, '<span class="fn">$1</span>');
        document.getElementById('code-highlight').innerHTML = html;
    }

    function syncScroll(el) {
        const hl = document.getElementById('code-highlight');
        hl.scrollTop = el.scrollTop;
        hl.scrollLeft = el.scrollLeft;
    }

    // --- UI HELPERS ---
    function setSpeed(val) { delay = (11 - val) * 100; }
    function toggleTheme() { document.body.classList.toggle('dark-mode'); isDark = !isDark; }
    function showTab(t) {
        document.querySelectorAll('.tab').forEach(e => e.classList.remove('active'));
        document.getElementById(t==='editor'?'pane-editor':'pane-msg').style.display = 'flex';
        document.getElementById(t==='editor'?'pane-msg':'pane-editor').style.display = 'none';
        if(t==='editor') document.querySelector('.tab:first-child').classList.add('active');
        else document.getElementById('tab-msg').classList.add('active');
    }
    function logError(msg) {
        const p = document.getElementById('pane-msg');
        p.innerText = "SQL Error:\n" + msg;
        showTab('msg');
    }

    // --- SCHEMA EDITOR ---
    function renderSchema() {
        const container = document.getElementById('tables-container');
        container.innerHTML = '';
        Object.keys(appData).forEach(tableName => {
            const rows = appData[tableName];
            const cols = rows.length ? Object.keys(rows[0]) : ['id'];
            
            // Limit preview rows for performance
            const previewRows = rows.slice(0, 50);
            
            const card = document.createElement('div');
            card.className = 'table-card';
            const gridStyle = `grid-template-columns: repeat(${cols.length}, 1fr) 25px;`;
            
            let html = `
                <div class="card-title">
                    <span>${tableName} <span style="font-weight:normal; opacity:0.6; font-size:0.8em">(${rows.length} rows)</span></span>
                    <div class="icon-btn" onclick="dropTable('${tableName}')">âœ• Table</div>
                </div>
                <div style="overflow-x:auto;">
                    <div class="db-grid">
                        <div class="db-row-header" style="${gridStyle}">
                            ${cols.map(c => `
                                <div class="db-cell">
                                    <input class="cell-input" value="${c}" title="${c}" onchange="renameCol('${tableName}', '${c}', this.value)">
                                    <div class="icon-btn" style="position:absolute; right:0; top:0; color:var(--danger);" onclick="dropCol('${tableName}','${c}')">Ã—</div>
                                </div>
                            `).join('')}
                            <div class="db-cell"></div>
                        </div>`;
            
            previewRows.forEach((row, rIdx) => {
                html += `<div class="db-row" style="${gridStyle}">`;
                cols.forEach(c => {
                    const val = row[c] !== null ? row[c] : 'NULL';
                    html += `<div class="db-cell"><input class="cell-input" value="${val}" title="${val}" onchange="updateCell('${tableName}', ${rIdx}, '${c}', this.value)"></div>`;
                });
                html += `<div class="db-cell" style="text-align:center;"><div class="icon-btn" onclick="dropRow('${tableName}', ${rIdx})">Ã—</div></div></div>`;
            });
            html += `</div></div>
                <div class="card-actions">
                    <button onclick="addRow('${tableName}')">+ Row</button>
                    <button onclick="addCol('${tableName}')">+ Col</button>
                </div>`;
            card.innerHTML = html;
            container.appendChild(card);
        });
    }

    // --- DATA OPS ---
    function addTable() { const n = document.getElementById('new-table-name').value.trim(); if(n&&!appData[n]) { appData[n]=[{id:1}]; renderSchema(); } }
    function dropTable(t) { delete appData[t]; renderSchema(); }
    function addRow(t) { const cols=Object.keys(appData[t][0]||{id:0}); const r={}; cols.forEach(k=>r[k]=null); appData[t].push(r); renderSchema(); }
    function dropRow(t,i) { appData[t].splice(i,1); renderSchema(); }
    function addCol(t) { const r=appData[t]; let k="c"+(Object.keys(r[0]||{}).length+1); if(!r.length) r.push({[k]:null}); else r.forEach(x=>x[k]=null); renderSchema(); }
    function dropCol(t,k) { if(Object.keys(appData[t][0]).length<=1) return alert("Min 1 col"); appData[t].forEach(x=>delete x[k]); renderSchema(); }
    function updateCell(t,i,k,v) { if(!isNaN(v)&&v.trim()!=='') v=Number(v); appData[t][i][k]=v; }
    function renameCol(t,o,n) { if(!n||o===n)return; appData[t].forEach(r=>{r[n]=r[o]; delete r[o];}); renderSchema(); }

    // --- PIPELINE & EXECUTION (Same Logic) ---
    function parsePipeline(sql) {
        const steps = [];
        const words = sql.replace(/[\n\t]/g, ' ').split(/\s+/);
        let fromIdx = words.findIndex(w => w.toUpperCase() === 'FROM');
        if(fromIdx === -1) return [];
        
        const baseTable = words[fromIdx+1];
        const baseAlias = words[fromIdx+2] && !['JOIN','WHERE','GROUP','ORDER','LIMIT'].includes(words[fromIdx+2].toUpperCase()) ? words[fromIdx+2] : baseTable;
        steps.push({ type: 'FROM', table: baseTable, alias: baseAlias });

        let currentIdx = fromIdx + 2;
        while(currentIdx < words.length) {
            if(words[currentIdx].toUpperCase() === 'JOIN') {
                let onIdx = words.indexOf('ON', currentIdx);
                let joinTbl = words[currentIdx+1];
                let alias = (words[currentIdx+2] && words[currentIdx+2].toUpperCase()!=='ON') ? words[currentIdx+2] : joinTbl;
                let leftKey='', rightKey='';
                if(onIdx > -1) {
                    let condition = words.slice(onIdx+1, onIdx+4).join(''); 
                    let parts = condition.split('=');
                    if(parts.length===2) { leftKey=parts[0].trim(); rightKey=parts[1].trim(); }
                }
                steps.push({ type: 'JOIN', table: joinTbl, alias: alias, leftKey, rightKey });
            }
            if(words[currentIdx].toUpperCase() === 'WHERE') steps.push({ type: 'WHERE', text: 'Filter' });
            currentIdx++;
        }
        steps.push({ type: 'SELECT', text: 'Output' });
        return steps;
    }

    function prefixData(rows, alias) {
        return rows.map(r => {
            const newR = {};
            Object.keys(r).forEach(k => newR[`${alias}.${k}`] = r[k]);
            return newR;
        });
    }

    async function startExecution() {
        if(!SQL) return;
        const sql = document.getElementById('code-input').value;
        const status = document.getElementById('status-text');
        
        document.getElementById('anim-canvas').innerHTML = '';
        document.getElementById('res-table').querySelector('tbody').innerHTML = '';
        showTab('editor');
        
        const plan = parsePipeline(sql);
        const pipeCol = document.getElementById('pipeline-list');
        pipeCol.innerHTML = '';
        plan.forEach((s,i) => pipeCol.innerHTML += `<div id="step-${i}" class="pipe-step">${s.type} ${s.alias||''}</div>`);

        try {
            db = new SQL.Database();
            Object.keys(appData).forEach(t => {
                const rows = appData[t];
                const cols = Object.keys(rows[0]);
                db.run(`CREATE TABLE ${t} (${cols.join(',')})`);
                rows.forEach(r => db.run(`INSERT INTO ${t} VALUES (${cols.map(c=>`'${r[c]}'`).join(',')})`));
            });

            setStep(0, 'active');
            let baseStep = plan[0];
            let baseRows = prefixData(appData[baseStep.table], baseStep.alias);
            
            status.innerText = `Reading ${baseStep.table}...`;
            let rowCon = document.createElement('div');
            rowCon.className = 'viz-row-container';
            document.getElementById('anim-canvas').appendChild(rowCon);

            renderVizTable(rowCon, baseStep.alias, baseRows, 'viz-base');
            await wait(delay);
            setStep(0, 'done');

            let currentResult = baseRows;

            for(let i=1; i<plan.length; i++) {
                if(plan[i].type !== 'JOIN') continue;
                const step = plan[i];
                setStep(i, 'active');
                status.innerText = `Joining ${step.alias}...`;

                rowCon.insertAdjacentHTML('beforeend', '<div class="arrow-icon">âžœ</div>');
                const joinRowsRaw = appData[step.table];
                const joinRows = prefixData(joinRowsRaw, step.alias);
                renderVizTable(rowCon, step.alias, joinRows, `viz-join-${i}`);
                
                rowCon.insertAdjacentHTML('beforeend', '<div class="arrow-icon">=</div>');
                const interId = `viz-inter-${i}`;
                const interWrapper = createVizTableContainer(rowCon, "Intermediate", interId);

                const nextResult = [];
                for(let r1=0; r1<currentResult.length; r1++) {
                    const rowA = currentResult[r1];
                    hlRow('viz-base', r1, 'row-scanning');
                    
                    for(let r2=0; r2<joinRows.length; r2++) {
                        const rowB = joinRows[r2];
                        hlRow(`viz-join-${i}`, r2, 'row-scanning');
                        
                        let valA = rowA[step.leftKey] || rowA[step.rightKey];
                        let valB = rowB[step.leftKey] || rowB[step.rightKey];
                        
                        await wait(delay * 0.5);

                        if(valA && valB && valA == valB) {
                            hlRow(`viz-join-${i}`, r2, 'row-matched');
                            const merged = { ...rowA, ...rowB };
                            nextResult.push(merged);
                            addVizRow(interId, merged);
                            await wait(delay);
                        }
                        unhlRow(`viz-join-${i}`, r2, 'row-scanning');
                    }
                    unhlRow('viz-base', r1, 'row-scanning');
                }
                currentResult = nextResult; 
                if(i < plan.length - 1 && plan[i+1].type === 'JOIN') {
                    rowCon = document.createElement('div');
                    rowCon.className = 'viz-row-container';
                    document.getElementById('anim-canvas').appendChild(rowCon);
                    renderVizTable(rowCon, "Previous Result", currentResult, `viz-base`); 
                }
                setStep(i, 'done');
            }

            const lastStepIdx = plan.length-1;
            setStep(lastStepIdx, 'active');
            status.innerText = "Finalizing...";
            const res = db.exec(sql);
            if(res.length) renderFinalResult(res[0]);
            setStep(lastStepIdx, 'done');
            status.innerText = "Done";

        } catch (e) {
            logError(e.message);
        }
    }

    // --- VIZ HELPERS ---
    function createVizTableContainer(parent, title, id) {
        const wrapper = document.createElement('div');
        wrapper.className = 'v-table-wrapper';
        wrapper.innerHTML = `<div class="v-label">${title}</div><div class="v-table" id="${id}"></div>`;
        parent.appendChild(wrapper);
        return wrapper.querySelector('.v-table'); 
    }

    function renderVizTable(parent, title, data, id) {
        const tableDiv = createVizTableContainer(parent, title, id);
        if(!data.length) return;
        const cols = Object.keys(data[0]);
        const gridStyle = `grid-template-columns: repeat(${cols.length}, 1fr);`;
        let html = `<div class="v-row v-header-row" style="${gridStyle}">${cols.map(c=>`<div class="v-cell">${c}</div>`).join('')}</div>`;
        data.forEach((r, i) => {
            html += `<div class="v-row" id="${id}-r${i}" style="${gridStyle}">${Object.values(r).map(v=>`<div class="v-cell">${v}</div>`).join('')}</div>`;
        });
        tableDiv.innerHTML = html;
    }

    function addVizRow(tableId, rowData) {
        const tableDiv = document.getElementById(tableId);
        const cols = Object.keys(rowData);
        const gridStyle = `grid-template-columns: repeat(${cols.length}, 1fr);`;
        if(!tableDiv.children.length) tableDiv.innerHTML = `<div class="v-row v-header-row" style="${gridStyle}">${cols.map(c=>`<div class="v-cell">${c}</div>`).join('')}</div>`;
        const html = `<div class="v-row new-res-row" style="${gridStyle}">${Object.values(rowData).map(v=>`<div class="v-cell">${v}</div>`).join('')}</div>`;
        tableDiv.insertAdjacentHTML('beforeend', html);
        tableDiv.scrollTop = tableDiv.scrollHeight;
    }

    function renderFinalResult(res) {
        const table = document.getElementById('res-table');
        table.querySelector('thead').innerHTML = `<tr>${res.columns.map(c=>`<th>${c}</th>`).join('')}</tr>`;
        const tbody = table.querySelector('tbody');
        tbody.innerHTML = '';
        res.values.forEach(row => {
            tbody.innerHTML += `<tr class="new-res-row">${row.map(v=>`<td>${v}</td>`).join('')}</tr>`;
        });
    }

    function hlRow(tblId, rIdx, cls) {
        const r = document.getElementById(`${tblId}-r${rIdx}`);
        if(r) r.classList.add(cls);
    }
    function unhlRow(tblId, rIdx, cls) {
        const r = document.getElementById(`${tblId}-r${rIdx}`);
        if(r) r.classList.remove(cls);
    }
    function setStep(idx, status) {
        const els = document.getElementById('pipeline-list').children;
        if(els[idx]) els[idx].className = `pipe-step ${status}`;
    }

    const wait = ms => new Promise(r => setTimeout(r, ms));
    window.onload = init;

</script>
</body>
</html>
